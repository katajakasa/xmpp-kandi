\documentclass[finnish,nonumbib,nocopyright,shortthesis]{gradu2}

\usepackage{palatino}
\usepackage[latin1]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[finnish]{babel}
\usepackage{ae,aecompl}
\addto\captionsfinnish{\def\refname{L‰hteet}}
\usepackage[pdftex]{graphicx}

\title{XMPP-pikaviestinprotokolla}
\setauthor{Tuomas}{Virtanen}
\yhteystiedot{tuomas.virtanen@jyu.fi}
\translatedtitle{XMPP-Protocol}
\abstract{XMPP is a versatile and extensible instant messaging protocol based on open standards. It can be
used for eg. sending text messages and presence information, VoIP-calls and file transfers. This thesis 
examines the technical aspects of the protocol, and makes comparisons to other instant messaging protocols.}
\tiivistelma{XMPP on monipuolinen ja laajennettavissa oleva, avoimiin standardeihin perustuva pikaviestinprotokolla. 
Sit‰ voidaan k‰ytt‰‰ paitsi puhtaiden tekstiviestien l‰hett‰miseen ja olotilan tarkkailuun, myˆs 
esimerkiksi tiedostonsiirtoihin ja VoIP-puheluihin. T‰ss‰ tutkielmassa tutustutaan protokollan 
teknisiin ominaisuuksiin ja tehd‰‰n vertailuja muihin pikaviestinprotokolliin.}
\keywords{XMPP, Protocol, instant messaging}
\avainsanat{XMPP, protokolla, pikaviestint‰}
\setdate{31}{10}{2011}
\tyyppi{kandidaatintutkielma}

\begin{document}

\mainmatter

\section{Johdanto}

Pikaviestinn‰st‰ on tullut osa useiden tietokoneen, ja v‰hitellen myˆs erilaisten mobiililaitteiden 
k‰ytt‰jien arkea. Pikaviestint‰‰ k‰ytet‰‰n niin kotona, koulussa ja tˆiss‰. Erilaisia pikaviestin-ohjelmia 
on useita, ja viestint‰‰ voidaan harrastaa joko perinteisesti tekstiviestein, tai monipuolisemmin ‰‰nen ja 
videon avulla. WWW-ohjelmointitekniikoiden edistyess‰ pikaviestimi‰ lˆytyy jopa erilaisilta www-sivuilta, josta
hyv‰n‰ esimerkkin‰ toimii mm. Facebook-palvelu.

Erilaisten pikaviestinsovellusten tullessa markkinoille, syntyy myˆs uusia viestint‰protokollia ja m‰‰ritelmi‰
n‰iden sovellusten k‰yttˆˆn. T‰st‰ johtuukin nykymallin mukaisen pikaviestinn‰n suurin ongelma; eri pikaviestinverkkoihin
tarvitaan usein eri ohjelmat. Samalla k‰ytt‰j‰ll‰ saattaakin olla k‰ytˆss‰ useita ohjelmia, jotka toimivat omissa
viestint‰verkoissaan. Yrityksi‰ yhdist‰‰ eri pikaviestinverkkoja saman ohjelman k‰yttˆˆn on olemassa, mutta
kaikki n‰ist‰ ovat eri syist‰ ep‰t‰ydellisi‰.

Usein ongelmana pikaviestint‰protokollien toteuttamisessa on se, ett‰ pikaviestinverkon protokolla on jollain 
tavalla suljettu. Protokolla voi olla suljettu esimerkiksi lisenssiehdoiltaan, joilla sen k‰yttˆ‰ rajoitetaan muiden 
kuin sille suunnitellun ohjelman k‰yttˆˆn. Protokollan m‰‰ritelm‰ voi olla suljettu ja itse protokolla voi olla salattu jollain
salausalgoritmilla. Esimerkiksi MSN Messenger-ohjelman k‰ytt‰m‰n MSNP-protokollan m‰‰ritelm‰ ei ole julkinen. 
Skype-pikaviestinohjelman k‰ytt‰m‰ protokolla taas on t‰ysin salattu~\cite{skype1} Rijndael-algoritmilla. T‰llaisten ohjelmien 
k‰ytt‰mi‰ protokollia ei voida toteuttaa muihin pikaviestimiin ilman protokollan purkua, joka esimerkiksi Skypen tapauksessa
on toistaiseksi ollut vain osittain menestyksek‰st‰.

TODO! L‰hde skypen suojauksen murtamiselle, t‰st‰ oli slashdotissa keskustelua jokin aika sitten.

Extensible Messaging and Presence Protocol (XMPP) pyrkii olemaan mahdollisimman avoin ja laajennettavissa oleva,
yleisk‰yttˆinen protokolla kaikkeen pikaviestint‰‰n. Se hallitsee laajennuksia k‰ytt‰en mm. tekstiviestit, 
VoIP-puhelut sek‰ tiedostojen siirron k‰ytt‰jien v‰lill‰. XMPP-verkko sallii myˆs esimerkiksi siltaukset
muihin pikaviestinverkkoihin, kuten Internet Relay Chat (IRC). XMPP-protokollaa k‰ytt‰‰kin nyky‰‰n jo moni
tunnettu yritys sovelluksissaan, kuten mm. Nokia (Nokia Ovi), Google (Google Talk, Google Wave), 
LiveJournal (LJ Talk). Myˆs muunmuassa Facebook paljastaa XMPP-pohjaisen rajapinnan palvelun ulkopuolisille
k‰ytt‰jille.

Kandidaatintutkielma tarkastelee lyhyesti pikaviestint‰‰, ja keskittyy erityisesti XMPP-pikaviestinprotokollaan.
Luvussa 2 k‰sitell‰‰n pikaviestint‰‰ yleisesti, ja esitell‰‰n muutamia sen sovelluksia sek‰ protokollia.
Luvussa 3 esitell‰‰n XMPP-protokollaa ja sen rakennetta. Luvussa 4 perehdyt‰‰n XMPP-verkkoihin ja niiden 
eroihin muihin pikaviestinverkkoihin n‰hden. Luvussa 5 esitell‰‰n XMPP-protokollan pikaviestint‰‰n tarjoamia
ominaisuuksia, kuten tekstiviestej‰ ja olotilan hallintaa.

(L‰hteet k‰ytt‰ville yrityksille/sovelluksille)

\section{Pikaviestint‰ ja sen protokollat}
\subsection{Pikaviestinn‰n k‰sitteit‰}

Pikaviestinn‰ss‰ on Wikipedian m‰‰ritelm‰n~\cite{wiki1} mukaan kyse (l‰hes) reaaliaikaisesta, tekstipohjaisesta 
viestinn‰st‰ kahden tai useamman ihmisen v‰lill‰ tietokoneiden tai muiden laitteiden v‰lityksell‰. Tiedon siirto tapahtuu
Internetin tai muun verkon yli. Pikaviestint‰ voi monipuolisimmillaan olla myˆs videon tai ‰‰nen v‰lityksell‰ tapahtuvaa 
viestint‰‰.

\subsection{Pikaviestinn‰n sovellukset}

Pikaviestint‰‰ k‰ytet‰‰n nyky‰‰n moneen eri tarkoitukseen. Tunnetuinta pikaviestint‰ on luultavasti nuorison keskuudessa,
jotka ovat jo pitk‰‰n k‰ytt‰neet erilaisia ohjelmia sosiaalisten ryhmiens‰ v‰liseen viestint‰‰n. Nuorison keskuudessa
suosituimpia sovelluksia nyky‰‰n ovat muunmuassa facebook, MSN Messenger, Skype sek‰ tavallinen tekstiviestint‰. Myˆs muita
ohjelmia k‰ytet‰‰n.

Tyˆpaikoilla pikaviestint‰‰ k‰ytet‰‰n useing projektien koordinointiin eri tyˆryhmien v‰lill‰ sek‰ viestint‰‰n asiakkaiden
kanssa. Pikaviestinn‰n t‰rkeimpi‰ osa-alueita n‰iss‰ k‰yttˆtarkoituksissa ovatkin esimerkiksi puhe- sek‰ videopohjainen
pikaviestint‰.

(Muista lis‰t‰ l‰hde n‰ille!)

\section{XMPP-Protokolla}

Extensible Messaging and Presence Protocol (XMPP) on avoin, reaaliaikaiseen pikaviestint‰‰n ja olotilan ilmoittamiseen 
tarkoitettu XML-pohjainen standardi. Protokollaa kehittiin alun perin nimell‰ Jabber, ja se oli tarkoitettu saman 
nimiseen, vapaaseen l‰hdekoodiin perustuvaan pikaviestinohjelmaan. Vuonna 2002 perustettiin XMPP tyˆryhm‰ (XMPP WG), 
jonka teht‰v‰ksi tuli Jabber-protokollaan perustuvan pikaviestinprotokollan kehitys. Uuden, XMPP-nimisen protokollan 
tarkoitus oli soveltua Internet Engineering Task Forcen (IETF) tukemaksi pikaviestint‰- ja olotilan hallinta-protokollaksi. 
Kehitystyˆn tuloksena oli lopulta dokumentti, jossa m‰‰riteltiin protokollan perusominaisuudet ja laajennukset pikaviestint‰‰n.
Nyky‰‰n t‰t‰ perustoiminnallisuutta m‰‰ritell‰‰n RFC-dokumenteissa 3920 ja 3921. Myˆhemmin protokollaan on luotu laajennuksia 
esimerkiksi tiedostojen siirt‰miseen sek‰ VoIP-puheluihin. 

\subsection{Versiot ja ydinstandardi}

XMPP-protokollan kehityksen voidaan katsoa alkaneen vuonna 2000, jolloin julkaistiin XMPP:n edelt‰j‰n, IMPP:n suunnitelma. 
T‰m‰n j‰lkeen julkistettiin seuraavina vuosina useita suunnitelmadokumentteja muunmuassa salauksen soveltamisesta
pikaviestint‰‰n, merkkijonojen kuljettamisesta XML-virroissa sek‰ olotilan julkistamisesta.

Protokollan ensimm‰inen virallinen m‰‰ritelm‰ julkaistiin vuonna 2004 RFC-dokumenteissa 3920 - 3923. Seuraavien vuosien
aikana kehiteltiin useita laajennuksia mm. puheen ja videokuvan kuljettamiseen XMPP-verkossa, kunnes vuonna 2011 julkaistiin
protokollan seuraava versio RFC-dokumenteissa 6120 - 6122. Uusimmat m‰‰ritelm‰dokumentit ovat k‰yt‰nnˆss‰ viel‰
tarkastelun alla. T‰ss‰ dokumentissa k‰sitell‰‰nkin protokollaa viel‰ vanhemman, k‰ytetymm‰n ja tuetumman version pohjalta.

(T‰m‰n voisi sanailla paremmin, yhdist‰‰ edellisen kanssa ?)

\subsection{XML-tietovirrat}

XMPP-standardissa liikenne kuljetetaan yleens‰ XML-tietovirrassa.
XML-tietovirtaa voidaan ajatella s‰iliˆn‰, jota k‰ytet‰‰n XML-elementtien kuljettamiseen verkkoentiteettien v‰lill‰. 
Virran alku ilmoitetaan aina XML-tagilla "<stream>", jossa voidaan m‰‰ritell‰ attribuutteina myˆs esimerkiksi k‰ytett‰v‰ 
nimiavaruus ja nerkistˆ. Virran loppua merkkaa vastakkaisesti tagi "</stream>". Niin kauan kuin XML-virta 
on olemassa, sen luonut entiteetti voi l‰hett‰‰ m‰‰ritt‰m‰ttˆm‰n m‰‰r‰n XML-elementtej‰ vastaanottajalle. XML-tietovirta 
on aina yksisuuntainen; mik‰li vastaanottava p‰‰ haluaa l‰hett‰‰ viestej‰, pit‰‰ sen t‰t‰ varten erikseen neuvotella 
erillinen virta (Response Stream).

XML-tietovirrassa voidaan l‰hett‰‰ XMPP-standardin mukaan l‰hett‰‰ joko XML-s‰keistˆj‰ tai yhteyden neuvottelemiseen
tarvittavia XML-elementtej‰. Mik‰li entiteetti saa v‰‰r‰nmuotoisen paketin, se hyl‰t‰‰n. Yhteyden ja 
virran neuvottelee yleens‰ asiakas- tai palvelinentiteetti vastaanottavaan entiteettiin, joka on yleens‰ palvelin. 
Asiakas-palvelin yhteyksien lis‰ksi siis palvelin-palvelin yhteydet ovat myˆs mahdollisia.

\subsection{S‰keistˆt}

XMPP-protokollassa s‰keistˆ (Stanza) on itsen‰inen tietopaketti, joka voidaan l‰hett‰‰ entiteetilt‰ toiselle XML-virran yli. 
S‰keistˆ kuljetetaan aina suoraan XML-virran stream-juurielementin alla, ja voi olla nimelt‰‰n "message", "presence" tai "iq".
S‰keistˆjen nimiavaruuden on oltava "jabber:client" tai "jabber:server". Mik‰ tahansa muu tietovirrassa l‰hetetty paketti
ei ole s‰keistˆ. S‰keistˆ sis‰lt‰‰ yleens‰ yhden tai useampia lapsielementtej‰.

Stanzalla on kolme tyyppi‰, joilla m‰‰ritet‰‰n viestint‰mekanismi. "Push"-mekanismi on tarkoitettu yleiseen viestint‰‰n,
"publish-subscribe" yleiseen palvelimen ja verkon tilan viestitt‰miseen asiakkaille, ja "request-response" taas tiedon 
vaihtamiseen entiteettien kesken. "iq"-tyyppinen paketti on tyypilt‰‰n "request-response", kun taas presence ja message-elementit
ovat "push"-tyyppisi‰.

\section{Verkko}

XMPP-verkko on hajautettu, ja palvelimia voi olla useita. Palvelimet voivat olla yhteydess‰ toisiinsa
suoraan, tai v‰lipalvelimien v‰lityksell‰. Asiakkaat voivat halutessaan ottaa yhteyden mihin tahansa verkon
palvelimista.

\begin{figure}[htp]
	\centering
	\includegraphics[width=0.9\textwidth]{verkkokuva.png}
	\caption{XMPP-verkon rakenne} 
	\label{verkkokuva}
\end{figure}

\subsection{Palvelin}

Vaikka XMPP:n m‰‰ritelm‰ss‰ ei varsinaisesti m‰‰ritell‰ miten viestej‰ l‰hetet‰‰n, 
k‰ytet‰‰n protokollaa yleens‰ asiakas-palvelin-arkkitehtuurilla. Erona useisiin muihin 
tunnettuihin pikaviestinprotokolliin, kuten OSCAR ja MSNP on kuitenkin se, ett‰ XMPP-verkolla ei ole 
yht‰ keskitetty‰ autentikaatiopalvelinta. K‰yt‰nnˆss‰ siis kuka tahansa voi ajaa omaa palvelintaan, ja 
liitt‰‰ sen osaksi suurempaa verkkoa.

Palvelimen teht‰v‰n‰ XMPP-verkossa on TCP-yhteyksien vastaanotto sek‰ liikenteen v‰litt‰minen 
muille autentikoiduille k‰ytt‰jille, palvelimille ja muille kohteille. Palvelin myˆs reititt‰‰ 
asiakkaan l‰hett‰m‰t paketit oikeisiin kohteisiin. Palvelimet voivat myˆs tallentaa k‰ytt‰j‰kohtaisia 
tietoja, kuten kontaktilistan, joka voi sis‰lt‰‰ muita k‰ytt‰ji‰ mist‰ tahansa liitetyst‰ XMPP-verkosta.

\subsection{Asiakas}

Asiakas luo yhteyden palvelimeen TCP-protokollan yli tiettyyn palvelimen porttiin. Internet Assigned Numbers 
Authority (IANA) on m‰‰ritellyt XMPP-protokollan k‰yttˆˆn portin 5222, mutta muitakin saattaa olla k‰ytˆss‰. 
Asiakkaan teht‰v‰n‰ on l‰hett‰‰ viestej‰ ja tilatietoja palvelimelle, sek‰ vastaanottaa niit‰ palvelimelta. 
Asiakkaan on osattava v‰hint‰‰n avata yhteys XML-viestien l‰hett‰mist‰ ja vastaanottamista varten.

XMPP-verkossa jokaista asiakasta tai p‰‰tepistett‰ kutsutaan entiteetiksi, jolla on aina oma tunnisteensa 
nimelt‰‰n JID. Tunniste on kolmiosainen, esimerkiksi muotoa "<solmu@toimialue/resurssi>". Tunnisteessa 
toimialue-kentt‰ m‰‰rittelee k‰ytetyn palvelimen osoitteen, "solmu"-kentt‰ k‰ytt‰j‰n nimen ja "resurssi"-kentt‰
k‰ytt‰j‰lle kuuluvan toisen asiakaslaitteen. Protokolla salliikin useampien asiakasohjelmien kirjautumisen 
samalle palvelimelle samalla k‰ytt‰j‰tunnuksella, kunhan eri ohjelmille m‰‰ritell‰‰n oma kotiosoitteensa. 

Entiteeteille voidaan m‰‰ritt‰‰ myˆs t‰rkeystasoja, jolloin esimerkiksi osoitteeseen "<solmu@toimialue/matkapuhelin>" 
l‰hetetty viesti menee k‰ytt‰j‰n matkapuhelimeen, mutta osoitteeseen "<solmu@toimialue>" l‰hetetty viesti ohjautuu 
t‰rkeimm‰ksi m‰‰riteltyyn asiakasohjelmaan tai laitteeseen.

\subsection{V‰lipalvelin}

Koska XMPP-sallii useampien palvelinten toimimisen yhdess‰, voidaan XMPP-verkkoa laajentaa niinsanotuilla 
v‰lipalvelimilla (Gateway). V‰lipalvelimen teht‰v‰n‰ on muuntaa XMPP-viestej‰ sopivaksi v‰lipalvelimen 
toisella puolella toimivaan pikaviestinverkkoon, ja toisaalta toisesta verkosta tulevia viestej‰ XMPP-verkkoon 
sopiviksi. Tunnettuja v‰lipalvelimia on olemassa esimerkiksi SMTP, Internet Relay Chat, SIMPLE sek‰ SMS -verkkoja varten. 

Suurimpana ongelmana v‰lipalvelinten k‰ytˆss‰ on se, ett‰ protokollat eiv‰t aina ole t‰ysin yhteensopivia. T‰st‰ 
seuraa, ett‰ osa viesteiss‰ v‰litetyst‰ tiedosta ei v‰ltt‰m‰tt‰ ole esitett‰viss‰ toisella protokollalla. Ongelmia tulee
myˆs turvallisuuden kanssa, sill‰ l‰hetetyn viestin tai muun tiedon siirtyess‰ toiseen pikaviestinverkkoon, sen
turvallisuutta ei voida en‰‰ taata.

\subsection{Yhteyden suojaus}

XMPP-verkon kaikkien asiakkaiden ja palvelinten on tuettava TLS- ja SASL-metodeja tiedon salaamiseen. Salauksen k‰yttˆ
ei ole protokollan m‰‰ritelm‰dokumentissa vaadittua, mutta sit‰ suositellaan vahvasti. Myˆs palvelinten v‰listen
tietoliikenneyhteyksien v‰linen salaus on suositeltua, muttei vaadittua.

XMPP-verkossa m‰‰ritell‰‰n myˆs palvelinten v‰linen "server dialback" eli takaisinsoitto, jota voidaan k‰ytt‰‰
varmistamaan ett‰ palvelimeen yhdist‰v‰ toinen palvelin on olemassa. Protokollan m‰‰ritelm‰dokumenteissa
takaisinsoitto m‰‰ritell‰‰nkin hyvin heikoksi suojaukseksi, ja sen k‰yttˆ‰ ei en‰‰ suositella. Palvelinten 
ei odoteta en‰‰ tukevan kyseist‰ metodia.

\section{XMPP-protokollan toteutus}

XMPP-protokollan ydinm‰‰ritelm‰ on hyvin yksinkertainen. Ytimess‰ ei m‰‰ritell‰ esimerkiksi pikaviestint‰‰ tai
tilanhallintaa. Sen sijaan pikaviestint‰, tilanhallinta, puheviestint‰ sek‰ esimerkiksi videon ja tiedostojen v‰litys
ovat laajennuksia. Laajennukset m‰‰ritell‰‰n tarkemmin 

\subsection{Asiakkaan autentikointi}

XMPP-protokollan mukainen yhteys asiakas- ja palvelinsovelluksen v‰lill‰ aloitetaan luomalla XML-virta. 
Ensimm‰iseksi virrassa suoritetaan mahdollinen salauksen neuvottelu sopivin xml-s‰kein. Salauksen ep‰onnistuessa
palvelinsovellus voi vastata erilaisilla virheilmoituksilla. (TODO: L‰hde)

Kun haluttu yhteyden salauksen neuvottelu on suoritettu, aloitetaan virallinen yhteys l‰hett‰m‰ll‰ 
protokollam‰‰ritelm‰n mukainen stream-elementti. Palvelin vastaa elementtiin omalla "stream"-elementill‰‰n
sek‰ "stream:features"-elementill‰, jossa m‰‰ritell‰‰n autentikointiin k‰ytett‰v‰t suojausmetodit.
Tavallisesti k‰yt‰ss‰ on ainakin MD5-tiivistealgoritmi sek‰ puhdas teksti. Asiakasohjelma valitsee
suojausmetodin, ja ilmoittaa siit‰ "auth"-elementiss‰ palvelimelle.

Kun autentikaatiometodin valinta on suoritettu onnistuneesti, aloitetaan itse autentikaatio. Kaikki autentikaatiopaketit
kuljetetaan asiakkaan ja palvelimen v‰lill‰ "response" ja "challenge"-paketeissa base64-enkoodattuna. Virhetilanteessa
palvelin voi l‰hett‰‰ myˆs "failure"-elementin virhetietojen kera. L‰hetett‰v‰t elementit riippuvat valitusta 
autentikaatiometodista. Kun asiakas on vastannut oikein kaikkiin palvelimen l‰hett‰miin haasteisiin, saa asiakas
palvelimelta "success"-elementin. T‰m‰n j‰lkeen asiakas neuvottelee palvelimenkanssa uuden yhteyden "stream"-elementeill‰,
ja palvelin l‰hett‰‰ asiakkaalle listan palvelimen osaamista toiminnoista "stream:features"-elementiss‰. N‰it‰ voi olla
mm. sessionhallinta, pikaviestint‰ ja resurssien sidonta.

\subsection{Sessio ja resurssin sidonta}

Kun yhteys on luotu ja autentikointi on suoritettu, suoritetaan k‰ytt‰j‰n resurssin sidonta palvelimelle. Sidonta on tarpeellista,
mik‰li palvelin aiemmassa vaiheessa ilmoitti sen ominaisuutena asiakkaalle. Sidonnan tarkoituksena on yhdist‰‰ asiakkaan resurssi, 
esim. "kotikone" tai "kannettava" palvelimella toimivaksi JID-tunnisteeksi. T‰t‰ varten asiakas l‰hett‰‰ heti autentikoinnin 
onnistuttua palvelimelle iq-s‰keen, jossa l‰hetet‰‰n sen sis‰isess‰ "resource"-elementiss‰ haluttu resurssi. Asiakas voi antaa
myˆs palvelimen suorittaa resurssinimen valinnan automaattisesti j‰tt‰m‰ll‰ kent‰n ryhj‰ksi. Palvelimen ei myˆsk‰‰n ole pakko
hyv‰ksy‰ haluttua resurssia, vaan voi vaihtaa sen toiseen. Resurssin sidonnan onnistuttua palvelin l‰hett‰‰ asiakkaalle iq-s‰keen,
jonka sis‰isess‰ "jid"-elementiss‰ on asiakkaan t‰ysi JID-tunniste. T‰t‰ tunnistetta k‰ytet‰‰n asiakkaan tunnistamiseen palvelimella
loppuyhteyden aikana.

Mik‰li palvelin mainostaa asiakkaalle "stream:features"-elementiss‰ sessio-ominaisuutta, ja mik‰li asiakasohjelma haluaa
k‰ytt‰‰ palvelimen pikaviestint‰- ja tilanhallintaominaisuuksia, on asiakkaan neuvoteltava palvelimen kanssa sessio. T‰m‰ tehd‰‰n
l‰hett‰m‰ll‰ palvelimelle sopiva iq-s‰e. Palvelin vastaa t‰h‰n joko onnistumista merkkaavalla tyhj‰ll‰ iq-s‰keell‰, 
tai "error"-elementill‰ varustetulla virhett‰ merkkaavalla iq-s‰keell‰. Mik‰li session luonti ep‰onnistuu, voi se olla merkki
siit‰, ett‰ asiakkaalla ei ole oikeuksia pikaviestint‰‰n palvelimella. Kun session luonti on suoritettu, sanotaan
resurssin XMPP-terminologiassa olevan aktiivinen.

\begin{verbatim}
t‰h‰n esimerkki paketeista (vaiko Liitteeseen ?)
\end{verbatim}

\subsection{Tekstiviestien v‰litys}

Viestien l‰hetyst‰ varten asiakkaalla on oltava t‰ysi JID. Viestipakettina k‰ytet‰‰n message-s‰ett‰, jolla on oltava
aina v‰hint‰‰n "to"-parametri viestin vastaanottajan JID:t‰ varten. Vastaanottajan JID voi sis‰lt‰‰ resurssin, mik‰li viesti
on suunnattu vastaanottajan tietylle resurssille. Mik‰li resurssia ei m‰‰ritet‰, suuntautuu viesti vastaanottajan
kaikkiin resursseihin. Elementiss‰ voidaan m‰‰ritell‰ myˆs "from"-parametri, johon sijoitetaan viestin l‰hett‰j‰n JID.
Mik‰li l‰hett‰j‰n JID sis‰lt‰‰ resurssinimen, suunnataan takaisin tulevat viestit t‰h‰n resurssiin.

Message-s‰e sis‰lt‰‰ aina "body"-elementin, jossa on kuljetettava viesti. Viestin pituudelle ei teoriassa ole m‰‰ritetty rajaa,
mutta asiakasohjelmat saattavat itse lyhent‰‰ viesti‰. S‰e voi sis‰lt‰‰ myˆs "thread"-elementin, jolla ilmoitetaan keskustelu,
johon viesti liittyy. Mik‰li viestiin tai keskusteluun halutaan m‰‰ritt‰‰ aihe, se voidaan l‰hett‰‰ "subject"-elementiss‰. Kun
s‰e on rakennettu, se voidaan l‰hett‰‰ palvelimelle, ja palvelin hoitaa s‰keen siirron oikealle vastaanottajalle.

\subsection{Yst‰v‰listan hallinta}

Yst‰v‰lista pit‰‰ sis‰ll‰‰n tiedot k‰ytt‰j‰n listalle lis‰‰mist‰ JID-kontakteista. Yst‰v‰listan s‰ilytyst‰ hallitsee palvelin,
ja asiakas voi pyyt‰‰ sen erikseen palvelimelta. Yst‰v‰listalle voidaan lis‰t‰ k‰ytt‰ji‰ vain, mik‰li lis‰yksen kohde sallii sen.
Yst‰v‰pyyntˆ‰ kutsutaan XMPP-terminologiassa tilaukseksi ("subscription"). Asiakas suorittaa tilauksen l‰hett‰m‰ll‰ palvelimelle
sis‰llˆttˆm‰n presence-s‰keen, jonka "type"-parametrina on "subscribe" ja "to"-parametrina lis‰yksen kohteen JID ilman resurssia.
Vastaanottaja vastaa t‰h‰n l‰hett‰m‰ll‰ vastaavan paketin, jonka "type"-parametrina on joko "subscribed" (tilattu) tai 
"unsubscribed" (ei tilattu).

\begin{figure}[htp]
	\centering
	\includegraphics[scale=0.7]{kaverilista.png}
	\caption{Tyypillinen kontaktilista pikaviestinohjelmassa} 
	\label{kontaktilista}
\end{figure}

\subsection{Tilatiedot}

Asiakas voi l‰hett‰‰ yst‰v‰listallaan oleville k‰ytt‰jille tietoja omasta tilastaan, 
esimerkiksi "poissa" tai "‰l‰ h‰iritse". Asiakas l‰hett‰‰ tilanvaihtopyynnˆn palvelimelle, joka hoitaa sen eteenp‰in yst‰v‰listan 
kaikille kontakteille. Mik‰li asiakas ei viestit‰ tilaa palvelimelle, voi palvelin myˆs erikseen pyyt‰‰ sit‰. Tilamuutokset 
l‰hetet‰‰n aina kaikkien kontaktien kaikille resursseille.

Tilanmuutospyyntˆ tehd‰‰n l‰hett‰m‰ll‰ palvelimelle presence-s‰e. Tila ilmoitetaan s‰keess‰ elementiss‰ "show". Asiakas 
voi myˆs l‰hett‰‰ lis‰tietoja tilasta "status"-elementiss‰. Lis‰tietoelementiss‰ voi olla pitempikin teksti, mutta tilaelementin
sis‰ltˆ on yleens‰ lyhyt. 

\section{Muita protokollia}

XMPP-protokollan lis‰ksi on olemassa myˆs muita pikaviestinprotokollia, kuten muunmuassa MSNP, Skype, IRC, SIMPLE 
ja useita muita. N‰ist‰ SIMPLE suunniteltiin myˆs mahdollisimman yleisk‰yttˆiseksi ja avoimeksi, ja on k‰ytˆss‰ 
esimerkiksi joissain VoIP-sovelluksissa. 

Skype-protokolla on t‰ysin suljettu ja salattu ~\cite{skype1}. Protokollasta on onnistuttu selvitt‰m‰‰n osia, mutta ainakin
toistaiseksi sen toiminta on suurilta osin tuntematon. Skype-verkko on rakenteeltaan hajautettu, mutta
verkkoon kirjautuminen pit‰‰ tehd‰ erillisen Skype Limited-yhtiˆn kirjautumispalvelimen kautta.

MSNP (Microsoft Notification Protocol) on Microsoft-yhtiˆn protokolla pikaviestint‰‰n. Sit‰ k‰ytet‰‰n muunmuassa yhtiˆn 
omissa Windows Messenger, MSN Messenger ja Windows Live Messenger-sovelluksissa. Myˆs esimerkiksi avoimeen l‰hdekoodiin 
perustuvat pikaviestinsovellukset Pidgin ja Trillian taitavat viestinn‰n MSNP-protokollan yli. MSNP-verkko on rakenteeltaan 
keskitetty ~\cite{msnp}, ja kirjautumispalvelimet ovat Microsoftin hallinnassa. Microsoft ei julkaise protokollan m‰‰ritelm‰‰, vaan
jokainen protokollan versio on k‰ytt‰jien toimesta purettu ja m‰‰ritelm‰t julkaistu ep‰virallisesti. T‰ll‰ hetkell‰ MSNP:n 
viimeisin julkaistu versio on 19, vaikka kirjautumispalvelimet tukevatkin kaikkia protokollia versiosta 8 l‰htien.

IRC (Internet Relay Chat) on vuonna 1988 Suomessa kehitetty tekstipohjainen pikaviestinprotokolla. Protokolla on avoin, 
ja siit‰ on useita versioita sek‰ toteutuksia. Rakenteeltaan IRC on hajautettu. Palvelimet voidaan
yhdist‰‰ kokonaisuuksiksi eli keskusteluverkoiksi, joilla on nimi (mm. ircnet). Keskusteluverkossa
voi olla useita keskustelukanavia, joille voi liitty‰ ~\cite{ircrfc}. 

\section{XMPP-protokollan edut ja heikkoudet}

\subsection{Avoimuus}
XMPP-protokolla on t‰ysin avoin, ja kuka tahansa voi k‰ytt‰‰ sit‰ ilman maksuja millek‰‰n taholle. 

(vertaile avoimuutta muihin, jne)


\subsection{Hyˆtysuhde}

XML-pohjaisten protokollien heikkoutena on pakettien suuri koko ja suhteellisen pieni hyˆtysuhde. Viestipakettien koko voi
olla moninkertainen itse paketissa l‰hetett‰v‰‰n tietoon.

(t‰nne lis‰‰ teksti‰)

\begin{figure}[htp]
	\centering
	\includegraphics[width=0.9\textwidth]{viestipaketti_cmp.png}
	\caption{Viestipaketin koko eri protokollissa} 
	\label{viestipaketticmpkuva}
\end{figure}

\subsection{Suojaus}


\section{Yhteenveto}

XMPP on nyky‰‰n jo eritt‰in tuettu standardi, ja soveltuu hyvin erilaisiin pikaviestinn‰n
k‰yttˆtarkoituksiin. Vaikka protokollaa ei nyky‰‰n viel‰ tuetakaan monissa suurimmista
pikaviestinohjelmista, se levi‰‰ koko ajan pienempien palveluiden kautta. Protokollan 
suurin hyˆty onkin sen ilmainen soveltaminen eri tarkoituksiin sek‰ hyv‰n m‰‰ritelm‰n
kautta saavutettu yhteensopivuus valmiiden sovellusten kanssa. Myˆs muihin pikaviestint‰verkkoihin
viestiminen on mahdollistettu siltapalvelinten avulla, joten verkon asteittainen p‰ivitt‰minen
on suhteellisen yksinkertaista. Laajennettavan rakenteensa avulla XMPP-protokolla on valmistautunut
sopeutumaan myˆs tulevaisuuden pikaviestinn‰n luomiin vaatimuksiin.

(Hieman lyhyt viel‰ ...)
(Lis‰‰ liitteet!)

\begin{thebibliography}{99}

\bibitem{rfc3920}
P. Saint-Andre, 
\textit{"Extensible Messaging and Presence Protocol (XMPP): Core"},
Saatavilla osoitteesta <URL: \texttt{http://www.xmpp.org/rfcs/rfc3920.html}>,
lokakuu 2004, RFC-3920.

\bibitem{rfc3921}
P. Saint-Andre, 
\textit{"Extensible Messaging and Presence Protocol (XMPP): Instant Messaging and Presence"},
Saatavilla osoitteesta <URL: \texttt{http://www.xmpp.org/rfcs/rfc3921.html}>,
lokakuu 2004, RFC-3921.

\bibitem{rfc3922}
P. Saint-Andre, 
\textit{"Mapping the Extensible Messaging and Presence Protocol (XMPP) to Common Presence and Instant Messaging (CPIM)"},
Saatavilla osoitteesta <URL: \texttt{http://tools.ietf.org/html/rfc3922}>,
lokakuu 2004, RFC-3922.

\bibitem{helxmpp}
Mikko Laukkanen,
\textit{"Extensible Messaging and Presence Protocol (XMPP)"},
Saatavilla osoitteesta <URL: \texttt{http://www.cs.helsinki.fi/u/kraatika/Courses/IPsem04s/xmpp.pdf}>, 
Helsingin yliopisto, viitattu 15.3.2008.

\bibitem{xep0166}
Scott Ludwig, Joe Beda, Peter Saint-Andre, Robert McQueen, Sean Egan ja Joe hildebrand, 
\textit{"XEP-0166: Jingle"},
Saatavilla osoitteesta <URL: \texttt{http://www.xmpp.org/extensions/xep-0166.html}>,
29.2.2008.

\bibitem{salin}
Peter Salin, 
\textit{"Mobile Instant Messaging Systems - A Comparative Study and Implementation"},
Saatavilla osoitteesta <URL: \texttt{http://www.tml.tkk.fi/anttiyj/Salin-IMPS.pdf}>,
Teknillinen korkeakoulu, 21.9.2004.

\bibitem{xmpporg1}
\textit{"Jabber Software Foundation Renamed to XMPP Standards Foundation"},
Saatavilla osoitteesta <URL: \texttt{http://www.xmpp.org/xsf/press/2007-01-16.shtml}>,
XMPP standards foundation, 16.1.2007, Denver, Yhdysvallat.

\bibitem{wiki1}
Wikipedia, 
\textit{"Instant messaging"},
Saatavilla osoitteesta <URL: \texttt{http://en.wikipedia.org/wiki/Instant\_messaging}>,
viitattu 27.11.2010.

\bibitem{skype1}
Salman A. Baset, Henning Schulzrinne,
\textit{"An Analysis of the Skype Peer-to-Peer Internet Telephony Protocol"},
Saatavilla osoitteesta <URL: \texttt{http://arxiv.org/pdf/cs/0412017}>,
Columbia University, New York, Yhdysvallat, 15.9.2004.

\bibitem{msnp}
MSNPiki, 
\textit{"MSN Protocol Version 8"},
Saatavilla osoitteesta <URL: \texttt{http://msnpiki.msnfanatic.com/index.php/Main\_Page}>,
viitattu 10.1.2011.

\bibitem{ircrfc}
Jarkko Oikarinen, Darren Reed,
\textit{"RFC1459 - Internet Relay Chat Protocol"},
Saatavilla osoitteesta <URL: \texttt{http://tools.ietf.org/html/rfc1459}>,
viitattu 31.10.2011

\bibitem{extxep}
Peter Saint-Andre,
\textit{"XEP-0001: XMPP Extension Protocols"}
Saatavilla osoitteesta <URL: \texttt{http://xmpp.org/extensions/xep-0001.pdf}>,
10.3.2010, XEP-0001.

\end{thebibliography}

\newpage
\pagestyle{empty}

\appendix

\section*{Liite 1. Yhteyden hallinta}
\addtocontents{toc}{
\protect \contentsline {section}{\hspace{0.5cm}1 Yhteyden hallinta}{}}

\begin{figure}[htp]
	\centering
	\includegraphics[scale=0.8]{yhteys.png}
	\caption{Yhteyden hallinta} 
	\label{yhteyskuva}
\end{figure}


\end{document}
